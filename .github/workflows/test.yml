name: Test Suite

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Compile project
      run: ./mvnw clean compile test-compile
      
    - name: Run all unit tests
      run: ./mvnw test -DexcludedGroups=integration
      env:
        FIRESTORE_INTEGRATION_ENABLED: false
        
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()    # run this step even if tests fail
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
        
    - name: Setup Firestore Emulator and run integration tests
      run: |
        # Install and start Firestore emulator
        sudo apt-get update
        sudo apt-get install -y google-cloud-cli-firestore-emulator
        gcloud beta emulators firestore start --host-port=localhost:8080 &
        
        # Wait for emulator to be ready
        echo "Waiting for Firestore emulator to start..."
        timeout=30
        while ! curl -s http://localhost:8080 >/dev/null && [ $timeout -gt 0 ]; do
          sleep 1
          timeout=$((timeout-1))
        done
        
        if [ $timeout -eq 0 ]; then
          echo "Firestore emulator failed to start within 30 seconds"
          exit 1
        fi
        
        echo "Firestore emulator is ready, running integration tests..."
        ./mvnw test -Dtest="FirestoreIntegrationTest" -Dspring.profiles.active=test
      env:
        FIRESTORE_EMULATOR_HOST: localhost:8080
        FIRESTORE_INTEGRATION_ENABLED: true
      continue-on-error: false  # Integration tests should pass if emulator works
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: success() || failure()
      with:
        files: target/site/jacoco/jacoco.xml
        fail_ci_if_error: false
        
  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run security audit
      run: ./mvnw org.owasp:dependency-check-maven:check
      continue-on-error: true
      
    - name: Upload security report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-report
        path: target/dependency-check-report.html